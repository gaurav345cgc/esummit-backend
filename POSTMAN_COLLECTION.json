{
  "info": {
    "name": "eSummit Backend API",
    "description": "Complete API collection for eSummit CGC Mohali backend",
    "schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json"
  },
  "variable": [
    {
      "key": "base_url",
      "value": "http://localhost:3000/api",
      "type": "string"
    },
    {
      "key": "access_token",
      "value": "",
      "type": "string"
    },
    {
      "key": "event_id",
      "value": "1",
      "type": "string"
    },
    {
      "key": "pass_id",
      "value": "1",
      "type": "string"
    },
    {
      "key": "pass_price",
      "value": "5000",
      "type": "string"
    },
    {
      "key": "razorpay_order_id",
      "value": "",
      "type": "string"
    },
    {
      "key": "order_id",
      "value": "",
      "type": "string"
    }
  ],
  "item": [
    {
      "name": "1. Health Check",
      "request": {
        "method": "GET",
        "header": [],
        "url": {
          "raw": "{{base_url}}/health",
          "host": ["{{base_url}}"],
          "path": ["health"]
        }
      }
    },
    {
      "name": "2. Authentication",
      "item": [
        {
          "name": "Register User",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test(\"Status code is 201\", function () {",
                  "    pm.response.to.have.status(201);",
                  "});",
                  "",
                  "pm.test(\"Response has access_token\", function () {",
                  "    var jsonData = pm.response.json();",
                  "    pm.expect(jsonData).to.have.property('access_token');",
                  "    pm.collectionVariables.set(\"access_token\", jsonData.access_token);",
                  "});"
                ],
                "type": "text/javascript"
              }
            }
          ],
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"email\": \"testuser@example.com\",\n  \"password\": \"Test123!@#\",\n  \"name\": \"Test User\",\n  \"phone\": \"9876543210\",\n  \"org\": \"CGC\",\n  \"year\": 2026\n}"
            },
            "url": {
              "raw": "{{base_url}}/register",
              "host": ["{{base_url}}"],
              "path": ["register"]
            }
          }
        },
        {
          "name": "Login User",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test(\"Status code is 200\", function () {",
                  "    pm.response.to.have.status(200);",
                  "});",
                  "",
                  "pm.test(\"Response has access_token\", function () {",
                  "    var jsonData = pm.response.json();",
                  "    pm.expect(jsonData).to.have.property('access_token');",
                  "    pm.collectionVariables.set(\"access_token\", jsonData.access_token);",
                  "});"
                ],
                "type": "text/javascript"
              }
            }
          ],
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"email\": \"testuser@example.com\",\n  \"password\": \"Test123!@#\"\n}"
            },
            "url": {
              "raw": "{{base_url}}/login",
              "host": ["{{base_url}}"],
              "path": ["login"]
            }
          }
        }
      ]
    },
    {
      "name": "3. Profile",
      "item": [
        {
          "name": "Get Profile",
          "request": {
            "method": "GET",
            "header": [
              {
                "key": "Authorization",
                "value": "Bearer {{access_token}}",
                "type": "text"
              }
            ],
            "url": {
              "raw": "{{base_url}}/profile",
              "host": ["{{base_url}}"],
              "path": ["profile"]
            }
          }
        },
        {
          "name": "Update Profile",
          "request": {
            "method": "PUT",
            "header": [
              {
                "key": "Authorization",
                "value": "Bearer {{access_token}}",
                "type": "text"
              },
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"name\": \"Updated Name\",\n  \"phone\": \"9999999999\",\n  \"org\": \"Updated Org\",\n  \"year\": 2025\n}"
            },
            "url": {
              "raw": "{{base_url}}/profile",
              "host": ["{{base_url}}"],
              "path": ["profile"]
            }
          }
        }
      ]
    },
    {
      "name": "4. Events",
      "item": [
        {
          "name": "List Events",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test(\"Status code is 200\", function () {",
                  "    pm.response.to.have.status(200);",
                  "});",
                  "",
                  "pm.test(\"Events is an array\", function () {",
                  "    var jsonData = pm.response.json();",
                  "    pm.expect(jsonData).to.be.an('array');",
                  "    if (jsonData.length > 0) {",
                  "        pm.collectionVariables.set(\"event_id\", jsonData[0].id);",
                  "    }",
                  "});"
                ],
                "type": "text/javascript"
              }
            }
          ],
          "request": {
            "method": "GET",
            "header": [],
            "url": {
              "raw": "{{base_url}}/events",
              "host": ["{{base_url}}"],
              "path": ["events"]
            }
          }
        },
        {
          "name": "Get Event Details",
          "request": {
            "method": "GET",
            "header": [],
            "url": {
              "raw": "{{base_url}}/events/{{event_id}}",
              "host": ["{{base_url}}"],
              "path": ["events", "{{event_id}}"]
            }
          }
        }
      ]
    },
    {
      "name": "5. Passes",
      "item": [
        {
          "name": "List Passes",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test(\"Status code is 200\", function () {",
                  "    pm.response.to.have.status(200);",
                  "});",
                  "",
                  "pm.test(\"Passes is an array\", function () {",
                  "    var jsonData = pm.response.json();",
                  "    pm.expect(jsonData).to.be.an('array');",
                  "    if (jsonData.length > 0) {",
                  "        var firstPass = jsonData.find(p => p.stock > 0);",
                  "        if (firstPass) {",
                  "            pm.collectionVariables.set(\"pass_id\", firstPass.id);",
                  "            pm.collectionVariables.set(\"pass_price\", firstPass.price);",
                  "        }",
                  "    }",
                  "});"
                ],
                "type": "text/javascript"
              }
            }
          ],
          "request": {
            "method": "GET",
            "header": [],
            "url": {
              "raw": "{{base_url}}/passes",
              "host": ["{{base_url}}"],
              "path": ["passes"]
            }
          }
        },
        {
          "name": "Buy Pass",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test(\"Status code is 201\", function () {",
                  "    pm.response.to.have.status(201);",
                  "});",
                  "",
                  "pm.test(\"Response has razorpay_order\", function () {",
                  "    var jsonData = pm.response.json();",
                  "    pm.expect(jsonData).to.have.property('razorpay_order');",
                  "    pm.collectionVariables.set(\"razorpay_order_id\", jsonData.razorpay_order.id);",
                  "});",
                  "",
                  "pm.test(\"Pass matches purchased pass\", function () {",
                  "    var jsonData = pm.response.json();",
                  "    pm.expect(jsonData.pass.id).to.eql(parseInt(pm.collectionVariables.get(\"pass_id\")));",
                  "});"
                ],
                "type": "text/javascript"
              }
            }
          ],
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Authorization",
                "value": "Bearer {{access_token}}",
                "type": "text"
              },
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"expected_amount\": {{pass_price}},\n  \"version\": 0\n}"
            },
            "url": {
              "raw": "{{base_url}}/passes/{{pass_id}}/buy",
              "host": ["{{base_url}}"],
              "path": ["passes", "{{pass_id}}", "buy"]
            }
          }
        },
        {
          "name": "Upgrade Pass",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test(\"Status code is 201\", function () {",
                  "    pm.response.to.have.status(201);",
                  "});",
                  "",
                  "pm.test(\"Response has upgrade_details\", function () {",
                  "    var jsonData = pm.response.json();",
                  "    pm.expect(jsonData).to.have.property('upgrade_details');",
                  "    pm.expect(jsonData.upgrade_details).to.have.property('upgrade_price');",
                  "});",
                  "",
                  "pm.test(\"Response has razorpay_order\", function () {",
                  "    var jsonData = pm.response.json();",
                  "    pm.expect(jsonData).to.have.property('razorpay_order');",
                  "    pm.collectionVariables.set(\"razorpay_order_id\", jsonData.razorpay_order.id);",
                  "});"
                ],
                "type": "text/javascript"
              }
            }
          ],
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Authorization",
                "value": "Bearer {{access_token}}",
                "type": "text"
              },
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"expected_amount\": 2000,\n  \"version\": 0\n}"
            },
            "url": {
              "raw": "{{base_url}}/passes/{{pass_id}}/upgrade",
              "host": ["{{base_url}}"],
              "path": ["passes", "{{pass_id}}", "upgrade"]
            }
          }
        }
      ]
    },
    {
      "name": "6. Orders",
      "item": [
        {
          "name": "Get Orders",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test(\"Status code is 200\", function () {",
                  "    pm.response.to.have.status(200);",
                  "});",
                  "",
                  "pm.test(\"Orders is an array\", function () {",
                  "    var jsonData = pm.response.json();",
                  "    pm.expect(jsonData).to.be.an('array');",
                  "});",
                  "",
                  "pm.test(\"Order contains purchased pass\", function () {",
                  "    var jsonData = pm.response.json();",
                  "    var orderId = pm.collectionVariables.get(\"razorpay_order_id\");",
                  "    if (orderId) {",
                  "        var order = jsonData.find(o => o.razorpay_payment_id === orderId);",
                  "        pm.expect(order).to.exist;",
                  "        if (order) {",
                  "            pm.collectionVariables.set(\"order_id\", order.id);",
                  "        }",
                  "    }",
                  "});"
                ],
                "type": "text/javascript"
              }
            }
          ],
          "request": {
            "method": "GET",
            "header": [
              {
                "key": "Authorization",
                "value": "Bearer {{access_token}}",
                "type": "text"
              },
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"expected_amount\": {{pass_price}},\n  \"version\": 0\n}"
            },
            "url": {
              "raw": "{{base_url}}/passes/{{pass_id}}/buy",
              "host": ["{{base_url}}"],
              "path": ["passes", "{{pass_id}}", "buy"]
            }
          }
        }
      ]
    },
    {
      "name": "6. Orders",
      "item": [
        {
          "name": "Get Orders",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test(\"Status code is 200\", function () {",
                  "    pm.response.to.have.status(200);",
                  "});",
                  "",
                  "pm.test(\"Orders is an array\", function () {",
                  "    var jsonData = pm.response.json();",
                  "    pm.expect(jsonData).to.be.an('array');",
                  "});",
                  "",
                  "pm.test(\"Order contains purchased pass\", function () {",
                  "    var jsonData = pm.response.json();",
                  "    var orderId = pm.collectionVariables.get(\"razorpay_order_id\");",
                  "    if (orderId) {",
                  "        var order = jsonData.find(o => o.razorpay_payment_id === orderId);",
                  "        pm.expect(order).to.exist;",
                  "        if (order) {",
                  "            pm.collectionVariables.set(\"order_id\", order.id);",
                  "        }",
                  "    }",
                  "});"
                ],
                "type": "text/javascript"
              }
            }
          ],
          "request": {
            "method": "GET",
            "header": [
              {
                "key": "Authorization",
                "value": "Bearer {{access_token}}",
                "type": "text"
              }
            ],
            "url": {
              "raw": "{{base_url}}/orders",
              "host": ["{{base_url}}"],
              "path": ["orders"]
            }
          }
        }
      ]
    },
    {
      "name": "7. Dashboard",
      "item": [
        {
          "name": "Get Dashboard",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test(\"Status code is 200\", function () {",
                  "    pm.response.to.have.status(200);",
                  "});",
                  "",
                  "pm.test(\"Dashboard has my_passes\", function () {",
                  "    var jsonData = pm.response.json();",
                  "    pm.expect(jsonData).to.have.property('my_passes');",
                  "    pm.expect(jsonData.my_passes).to.be.an('array');",
                  "});",
                  "",
                  "pm.test(\"Purchased pass appears in my_passes\", function () {",
                  "    var jsonData = pm.response.json();",
                  "    var orderId = pm.collectionVariables.get(\"order_id\");",
                  "    if (orderId) {",
                  "        var pass = jsonData.my_passes.find(p => p.id === orderId);",
                  "        pm.expect(pass).to.exist;",
                  "    }",
                  "});"
                ],
                "type": "text/javascript"
              }
            }
          ],
          "request": {
            "method": "GET",
            "header": [
              {
                "key": "Authorization",
                "value": "Bearer {{access_token}}",
                "type": "text"
              }
            ],
            "url": {
              "raw": "{{base_url}}/dashboard",
              "host": ["{{base_url}}"],
              "path": ["dashboard"]
            }
          }
        }
      ]
    },
    {
      "name": "8. Webhook",
      "item": [
        {
          "name": "Simulate Razorpay Webhook",
          "event": [
            {
              "listen": "prerequest",
              "script": {
                "exec": [
                  "// Calculate webhook signature",
                  "const crypto = require('crypto');",
                  "const body = JSON.stringify(pm.request.body.raw);",
                  "const secret = pm.environment.get('RAZORPAY_WEBHOOK_SECRET') || 'ecell-sarang';",
                  "const signature = crypto.createHmac('sha256', secret).update(body).digest('hex');",
                  "pm.request.headers.add({",
                  "    key: 'x-razorpay-signature',",
                  "    value: signature",
                  "});"
                ],
                "type": "text/javascript"
              }
            },
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test(\"Status code is 200\", function () {",
                  "    pm.response.to.have.status(200);",
                  "});",
                  "",
                  "pm.test(\"Webhook processed successfully\", function () {",
                  "    var jsonData = pm.response.json();",
                  "    pm.expect(jsonData).to.have.property('ok');",
                  "    pm.expect(jsonData.ok).to.be.true;",
                  "});"
                ],
                "type": "text/javascript"
              }
            }
          ],
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"event\": \"payment.captured\",\n  \"payload\": {\n    \"payment\": {\n      \"entity\": {\n        \"id\": \"pay_TEST123\",\n        \"order_id\": \"{{razorpay_order_id}}\",\n        \"amount\": {{pass_price}}00,\n        \"currency\": \"INR\",\n        \"status\": \"captured\",\n        \"created_at\": 1707288000\n      }\n    }\n  }\n}"
            },
            "url": {
              "raw": "{{base_url}}/webhook/razorpay",
              "host": ["{{base_url}}"],
              "path": ["webhook", "razorpay"]
            }
          }
        }
      ]
    }
  ]
}
